
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // By default, deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // âœ… ALLOW GAME TO READ HINTS
    match /hints/{hintId} {
      allow read: if true;
    }

    // User Profiles
    match /userProfiles/{userId} {
      // Anyone can read a user profile (for leaderboards)
      allow get, list: if isSignedIn();
      
      // Only the owner can create their own profile
      allow create: if isOwner(userId)
                    && request.resource.data.totalScore == 0
                    && request.resource.data.highestLevel == 1
                    && request.resource.data.hints == 5;

      // The owner can update their profile under specific conditions
      allow update: if isOwner(userId) && (
                      // Allow username update
                      (request.resource.data.keys().hasAll(['username', 'updatedAt']) && request.resource.data.username is string) ||
                      // Allow score/level update from winning a game
                      (request.resource.data.keys().hasAll(['totalScore', 'highestLevel', 'rank', 'updatedAt'])
                        && request.resource.data.totalScore > resource.data.totalScore
                        && request.resource.data.totalScore <= resource.data.totalScore + 30 // Max score per round is 30
                      ) ||
                      // Allow hint purchase/usage
                      (request.resource.data.keys().hasAll(['hints', 'updatedAt']) &&
                        // Allow using a hint (decrement)
                        (request.resource.data.hints == resource.data.hints - 1 ||
                        // Allow purchasing hints (increment)
                         request.resource.data.hints > resource.data.hints)
                      ) ||
                       // Allow theme purchase
                      (request.resource.data.keys().hasAll(['purchasedThemes', 'updatedAt']))
                    );
      
      // The owner can delete their own profile
      allow delete: if isOwner(userId);
    }
    
    match /leaderboardEntries/{leaderboardEntryId} {
        allow read: if true;
        allow create, update: if isSignedIn();
    }
    
    match /userProfiles/{userId}/gameSessions/{gameSessionId} {
        allow read, write: if isOwner(userId);
    }
  }
}
